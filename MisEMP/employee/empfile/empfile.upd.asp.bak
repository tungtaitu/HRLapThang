<%@LANGUAGE="VBSCRIPT" %>
<!-- #include file = "../../GetSQLServerConnection.fun" -->
<!-- #include file="../../ADOINC.inc" -->
<%
'Session("NETUSER")=""
'SESSION("NETUSERNAME")=""

'Response.Expires = 0
'Response.Buffer = true

Set CONN = GetSQLServerConnection()

empautoid = TRIM(REQUEST("empautoid"))
EMPID=TRIM(REQUEST("EMPID"))	'員工編號
INDAT=TRIM(REQUEST("INDAT"))	'到職日
WHSNO=TRIM(REQUEST("WHSNO"))	'廠別
UNITNO=TRIM(REQUEST("UNITNO"))	'處/所
GROUPID=TRIM(REQUEST("GROUPID"))	'組/部門
ZUNO=TRIM(REQUEST("ZUNO"))	'單位
EMPNAM_CN=TRIM(REQUEST("NAM_CN"))	'姓名(中)
EMPNAM_VN=TRIM(REQUEST("NAM_VN"))	'姓名(越)
COUNTRY=TRIM(REQUEST("COUNTRY"))	'國籍
BYY=TRIM(REQUEST("BYY"))
BMM=TRIM(REQUEST("BMM"))
BDD=TRIM(REQUEST("BDD"))
AGES=TRIM(REQUEST("AGES"))	'年齡
SEX=TRIM(REQUEST("SEXSTR"))	'性別
JOB=TRIM(REQUEST("JOB"))	'職等
PERSONID=TRIM(REQUEST("PERSONID"))	'身分証字號
BHDAT=TRIM(REQUEST("BHDAT"))	'簽約日(保險日)
PASSPORTNO=TRIM(REQUEST("PASSPORTNO"))	'護照號碼
VISANO=TRIM(REQUEST("VISANO"))	'簽證號碼
PDUEDATE=TRIM(REQUEST("PDUEDATE"))	'護照有效期
VDUEDATE=TRIM(REQUEST("VDUEDATE"))	'簽證有效期
PHONE=TRIM(REQUEST("PHONE"))	'聯絡電話
MOBILEPHONE=TRIM(REQUEST("MOBILEPHONE"))	'手機
HOMEADDR=TRIM(REQUEST("HOMEADDR"))	'聯絡地址
EMAIL=TRIM(REQUEST("EMAIL"))	'EMAIL
OUTDAT=TRIM(REQUEST("OUTDAT"))	'離職日 
MEMO=TRIM(REQUEST("MEMO"))	'其他說明
GTDAT=TRIM(REQUEST("GTDAT"))	'加入工團(年月)
marryed = REQUEST("marryed") '婚姻狀況
SCHOOL = REQUEST("SCHOOL") '婚姻狀況
PHOTOS=TRIM(REQUEST("PHOTOS"))	'照片檔名

IF MEMO<>"" THEN
	MEMOSTR = REPLACE(MEMO, "'", "" )
	MEMOSTR = REPLACE (MEMOSTR, vbCrLf ,"<br>")
END IF

SHIFT = REQUEST("SHIFT")

'--------------------------------
totalpage = request("totalpage")
currentpage = request("currentpage")
RecordInDB = request("RecordInDB")

IF REQUEST("ACT")="EMPEDIT"  THEN
	'年假(特休),以每月1日為基礎,工作滿一個月年假一天,隔年3個月內需休完,年資滿5,10...年,年假13 ,14...天
	IF RIGHT(INDAT,2)<>"01" THEN
		IF MID(INDAT,6,2)+1>12 THEN
			CALCDAT=TRIM(CSTR(YEAR(INDAT)+1))&"/01/01"
		ELSE
			CALCDAT=TRIM(CSTR(YEAR(INDAT)))&"/"&TRIM(CSTR(MONTH(INDAT)+1))&"/01"
		END IF
	ELSE
		CALCDAT = INDAT
	END IF
	'特休天數 ----------------------- +	 每滿5年加一天年假
	TXD=DATEDIFF("M",CALCDAT, DATE()) + ( FIX(CINT(YEAR(DATE())-YEAR(INDAT))/CINT(5)))
	RESPONSE.WRITE CALCDAT & "-"&TXD &"<br>"
	'RESPONSE.END 
	if TRIM(OUTDATE)<>"" THEN 
		SQL="UPDATE EMPFILE SET INDAT='"& INDAT &"', TX='"& TXD &"', WHSNO = '"& WHSNO &"', GROUPID='"& GROUPID &"',  "&_
			"UNITNO='"& UNITNO &"', ZUNO='"& ZUNO &"', EMPNAM_CN='"& EMPNAM_CN &"', EMPNAM_VN=N'"& EMPNAM_VN &"', "&_
			"COUNTRY='"& COUNTRY &"', BYY='"& BYY &"', BMM='"& BMM &"', BDD='"& BDD &"',  AGES='"& AGES &"', SEX='"& SEX &"', JOB='"& JOB &"',"&_
			"PERSONID='"& PERSONID &"', BHDAT='"& BHDAT &"', PASSPORTNO='"& PASSPORTNO &"', "&_
			"VISANO='"& VISANO &"', PDUEDATE='"& PDUEDATE &"', VDUEDATE='"& VDUEDATE &"', PHONE='"& PHONE &"', "&_
			"MOBILEPHONE='"& MOBILEPHONE &"', HOMEADDR=N'"& HOMEADDR &"', EMAIL='"& EMAIL &"', OUTDAT='"& OUTDAT &"', "&_
			"GTDAT='"& GTDAT &"', MEMO='"& MEMOSTR &"', PHOTOS='"& PHOTOS &"' ,mdtm=getdate(), muser='"& session("NETuser") &"', "&_
			"MARRYED='"& MARRYED &"' , SCHOOL='"& SCHOOL &"' , SHIFT = '"& SHIFT &"' "&_
			"WHERE AUTOID='"& empautoid &"' AND EMPID='"& EMPID &"' "
	ELSE
		SQL="UPDATE EMPFILE SET INDAT='"& INDAT &"', TX='"& TXD &"', WHSNO = '"& WHSNO &"', GROUPID='"& GROUPID &"',  "&_
			"UNITNO='"& UNITNO &"', ZUNO='"& ZUNO &"', EMPNAM_CN='"& EMPNAM_CN &"', EMPNAM_VN=N'"& EMPNAM_VN &"', "&_
			"COUNTRY='"& COUNTRY &"', BYY='"& BYY &"', BMM='"& BMM &"', BDD='"& BDD &"',  AGES='"& AGES &"', SEX='"& SEX &"', JOB='"& JOB &"',"&_
			"PERSONID='"& PERSONID &"', BHDAT='"& BHDAT &"', PASSPORTNO='"& PASSPORTNO &"', "&_
			"VISANO='"& VISANO &"', PDUEDATE='"& PDUEDATE &"', VDUEDATE='"& VDUEDATE &"', PHONE='"& PHONE &"', "&_
			"MOBILEPHONE='"& MOBILEPHONE &"', HOMEADDR=N'"& HOMEADDR &"', EMAIL='"& EMAIL &"', OUTDAT='"& OUTDAT &"',  "&_
			"GTDAT='"& GTDAT &"', MEMO='"& MEMOSTR &"', PHOTOS='"& PHOTOS &"' ,mdtm=getdate(), muser='"& session("NETuser") &"', "&_
			"MARRYED='"& MARRYED &"' , SCHOOL='"& SCHOOL &"' , SHIFT = '"& SHIFT &"' "&_
			"WHERE AUTOID='"& empautoid &"' AND EMPID='"& EMPID &"' "
	END IF		
	conn.execute(sql)
	RESPONSE.WRITE SQL 
	RESPONSE.END 
	'RESPONSE.REDIRECT "empfile.EDIT.ASP?GROUPID="& GROUPID &"&EMPID="& EMPID
%>	<script language=vbscript>
		open "empfile.EDIT.asp?GROUPID=<%=GROUPID%>&empid=<%=EMPID%>" , "Fore",  "top=10, left=10, width=550, scrollbars=yes"
		'OPEN "empfile.EDIT.ASP" , "Fore"
	</script>
<%
ELSEIF REQUEST("ACT")="EMPDEL"  THEN
	SQL="UPDATE EMPFILE SET STATUS='D', MDTM=GETDATE(), MUSER='"&SESSION("NETUSER")&"' WHERE EMPID='"& EMPID &"' "
	conn.execute(sql)
	RESPONSE.REDIRECT "empfile.edit.ASP"
ELSEIF REQUEST("ACT")="EMPADDNEW" THEN
	SQL="INSERT INTO EMPFILE ( EMPID, INDAT, TX, WHSNO, GROUPID, UNITNO, ZUNO, EMPNAM_CN, EMPNAM_VN, COUNTRY, "&_
		"BYY, BMM, BDD, AGES, SEX, JOB, PERSONID, BHDAT, PASSPORTNO, PDUEDATE, VISANO, VDUEDATE, PHONE, "&_
		"MOBILEPHONE, HOMEADDR, EMAIL, GTDAT, MEMO, MDTM, MUSER, BB, PHU, CV, NN, KT, MT, TTKH , marryed, SCHOOL , SHIFT  ) VALUES ( "&_
		"'"& EMPID &"', '"& INDAT &"', '0', '"& WHSNO &"', '"& GROUPID &"', '"& UNITNO &"', '"& ZUNO &"', '"& EMPNAM_CN &"', "&_
		"N'"& EMPNAM_VN &"', '"& COUNTRY &"', '"& BYY &"', '"& BMM &"', '"& BDD &"', '"& AGES &"', "&_
		"'"& SEX &"', '"& JOB &"', '"& PERSONID &"', '"& BHDAT &"' , '"& PASSPORTNO &"' ,'"& PDUEDATE &"' , "&_
		"'"& VISANO &"', '"& VDUEDATE &"', '"& PHONE &"', '"& MOBILEPHONE &"' , N'"& HOMEADDR &"' ,'"& EMAIL &"' , "&_
 		"'"& GTDAT &"', '"& MEMO &"', GETDATE() , '"& SESSION("NETUSER") &"', 'AA1', 0,0,0,0,0,0 , '"& marryed &"', '"& SCHOOL &"', '"& SHIFT &"'   ) "
 	conn.execute(sql)
%>	<script language=vbscript>
		'open "empfile.EDIT.asp?GROUPID=<%=GROUPID%>&empid=<%=EMPID%>" , "Fore",  "top=10, left=10, width=550, scrollbars=yes"
		OPEN "empfile.fore.ASP" , "Fore"
	</script>
<%
	'RESPONSE.REDIRECT "empfile.fore.ASP"
	response.end
END IF
%>
 